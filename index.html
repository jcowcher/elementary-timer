<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elementary Timer — Focus Timer for Deep Work</title>
<meta name="description" content="A minimalist visual focus timer inspired by the Minee Timer. Track deep work sessions, name your activities, and view weekly history. Elementary, my dear Watson.">
<meta name="keywords" content="focus timer, pomodoro, deep work, productivity timer, visual timer, study timer">
<meta name="author" content="Elementary Timer">
<meta name="theme-color" content="#FF6600">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://elementarytimer.com/">
<meta property="og:title" content="Elementary Timer — Focus Timer for Deep Work">
<meta property="og:description" content="A minimalist visual focus timer. Track deep work sessions, name your activities, and view weekly history.">
<meta property="og:site_name" content="Elementary Timer">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Elementary Timer — Focus Timer for Deep Work">
<meta name="twitter:description" content="A minimalist visual focus timer. Track deep work sessions, name your activities, and view weekly history.">

<link rel="canonical" href="https://elementarytimer.com/">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script
  async
  crossorigin="anonymous"
  data-clerk-publishable-key="pk_test_cmF0aW9uYWwtbWFydGVuLTMzLmNsZXJrLmFjY291bnRzLmRldiQ"
  src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
  type="text/javascript"
></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --orange: #FF6600;
    --orange-light: #FF8533;
    --orange-bg: rgba(255, 102, 0, 0.06);
    --orange-bg-hover: rgba(255, 102, 0, 0.10);
    --black: #1a1a1a;
    --gray-900: #2d2d2d;
    --gray-700: #555;
    --gray-500: #888;
    --gray-400: #aaa;
    --gray-300: #ccc;
    --gray-200: #e5e5e5;
    --gray-100: #f5f5f5;
    --white: #ffffff;
    --radius: 8px;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--white);
    color: var(--black);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Nav */
  nav {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.25rem 2.5rem;
    border-bottom: 1px solid var(--gray-200);
  }

  .logo {
    text-decoration: none;
  }

  nav .nav-date {
    font-size: 0.8rem;
    color: var(--gray-400);
    font-weight: 400;
    letter-spacing: 0.05em;
    font-variant-numeric: tabular-nums;
  }

  .nav-auth {
    position: absolute;
    left: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }

  .auth-btn {
    background: none;
    border: 1px solid var(--gray-200);
    border-radius: 100px;
    padding: 0.35rem 0.85rem;
    font-family: inherit;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--gray-700);
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .auth-btn:hover {
    border-color: var(--gray-400);
    color: var(--black);
  }

  .auth-avatar {
    position: relative;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--orange);
    color: #fff;
    font-size: 0.8rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: opacity 0.15s;
    user-select: none;
    letter-spacing: -0.02em;
  }

  .auth-avatar:hover {
    opacity: 0.85;
  }

  .auth-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    background: var(--white);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    min-width: 120px;
    z-index: 100;
  }

  .auth-dropdown.open {
    display: block;
  }

  .auth-dropdown button {
    width: 100%;
    background: none;
    border: none;
    padding: 0.5rem 0.75rem;
    font-family: inherit;
    font-size: 0.75rem;
    color: var(--gray-700);
    cursor: pointer;
    text-align: left;
  }

  .auth-dropdown button:hover {
    background: var(--gray-100);
  }

  .nav-logo-btn {
    position: absolute;
    right: 1.25rem;
    top: 50%;
    transform: translateY(-50%);
    background: var(--orange);
    color: #fff;
    font-size: 0.78rem;
    font-weight: 600;
    padding: 0.4rem 0.85rem;
    border-radius: 100px;
    text-decoration: none;
    letter-spacing: -0.01em;
    white-space: nowrap;
    transition: background 0.15s;
  }

  .nav-logo-btn:hover {
    background: var(--orange-light);
  }

  /* Main layout */
  .main {
    max-width: 960px;
    margin: 0 auto;
    padding: 3.5rem 2rem 4rem;
    display: flex;
    gap: 5rem;
    align-items: flex-start;
  }

  .timer-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .timer-heading-input {
    font-size: 0.95rem;
    font-weight: 500;
    letter-spacing: 0.12em;
    color: var(--gray-400);
    margin-bottom: 2.5rem;
    border: none;
    background: none;
    outline: none;
    text-align: center;
    font-family: inherit;
    width: 100%;
    max-width: 300px;
  }
  .timer-heading-input::placeholder {
    color: var(--gray-400);
  }
  .timer-heading-input:focus {
    color: var(--black);
  }

  /* Minee-style disc timer */
  .timer-wrap {
    position: relative;
    width: 340px;
    height: 340px;
    margin-bottom: 2rem;
    margin-top: 1rem;
  }

  .stopwatch-btn {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 14px;
    background: var(--gray-300);
    border-radius: 4px 4px 2px 2px;
    z-index: 3;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .stopwatch-btn::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    width: 12px;
    height: 4px;
    background: var(--gray-300);
    border-radius: 0 0 2px 2px;
  }

  .timer-body {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: var(--gray-100);
    box-shadow:
      0 8px 32px rgba(0,0,0,0.10),
      0 2px 8px rgba(0,0,0,0.06),
      inset 0 2px 4px rgba(255,255,255,0.8),
      inset 0 -1px 2px rgba(0,0,0,0.04);
    position: relative;
    overflow: hidden;
  }

  .timer-fill {
    position: absolute;
    inset: 8px;
    border-radius: 50%;
    background: conic-gradient(
      var(--orange) 0deg,
      var(--orange) 0deg,
      var(--gray-200) 0deg
    );
    transition: background 0.3s ease;
  }

  .timer-fill-inner {
    position: absolute;
    inset: 0;
    border-radius: 50%;
    /* Subtle inner ring for depth */
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.06);
  }

  /* Hide old SVG elements */
  .timer-wrap svg { display: none; }
  .dot { display: none; }

  .time-display {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 2;
  }

  .time-digits {
    font-size: 3.4rem;
    font-weight: 300;
    letter-spacing: -0.02em;
    color: var(--black);
    font-variant-numeric: tabular-nums;
    line-height: 1;
    text-shadow: none;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .time-digits.visible {
    opacity: 1;
  }

  .timer-wrap:hover .time-digits,
  .timer-wrap.active .time-digits {
    opacity: 1;
  }

  /* When timer is idle (no fill), digits should be dark */
  .time-digits.idle {
    color: var(--gray-400);
    text-shadow: none;
  }

  .time-label {
    font-size: 0.7rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255,255,255,0.8);
    margin-top: 0.4rem;
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    transition: opacity 0.4s ease;
  }

  .time-label.idle-label {
    color: var(--gray-400);
    text-shadow: none;
  }

  .time-label.running-label { display: none; }
  .time-label.paused-label { color: var(--gray-500); text-shadow: none; }

  /* Pulse glow when running */
  .timer-body.running {
    animation: discPulse 3s ease-in-out infinite;
  }

  @keyframes discPulse {
    0%, 100% { box-shadow: 0 8px 32px rgba(0,0,0,0.10), 0 2px 8px rgba(0,0,0,0.06), inset 0 2px 4px rgba(255,255,255,0.8); }
    50% { box-shadow: 0 8px 40px rgba(255,102,0,0.15), 0 2px 8px rgba(0,0,0,0.06), inset 0 2px 4px rgba(255,255,255,0.8); }
  }

  /* Controls */
  .controls {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .btn {
    height: 44px;
    padding: 0 1.75rem;
    border: none;
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 0.82rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .btn-primary {
    background: var(--orange);
    color: var(--white);
  }

  .btn-primary:hover {
    background: var(--orange-light);
  }

  .btn-secondary {
    background: var(--gray-100);
    color: var(--gray-700);
  }

  .btn-secondary:hover {
    background: var(--gray-200);
  }

  .btn svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
  }

  /* Session panel */
  .session-section {
    width: 300px;
    flex-shrink: 0;
  }

  .section-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid var(--black);
  }

  .section-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--black);
  }

  .section-meta {
    font-size: 0.75rem;
    color: var(--gray-500);
    font-weight: 400;
  }

  .session-list {
    list-style: none;
    max-height: 400px;
    overflow-y: auto;
  }

  .session-list::-webkit-scrollbar { width: 3px; }
  .session-list::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 3px; }

  .session-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.7rem 0;
    border-bottom: 1px solid var(--gray-100);
  }

  .session-item:last-child { border-bottom: none; }

  .session-info {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  .session-duration {
    font-size: 0.88rem;
    font-weight: 500;
    color: var(--black);
    font-variant-numeric: tabular-nums;
  }

  .session-timestamp {
    font-size: 0.72rem;
    color: var(--gray-500);
  }

  .session-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--orange);
    flex-shrink: 0;
    margin-right: 0.75rem;
  }

  .session-left {
    display: flex;
    align-items: center;
  }

  .session-delete {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--gray-300);
    padding: 0.25rem;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.15s, background 0.15s;
    opacity: 0;
  }

  .session-item:hover .session-delete {
    opacity: 1;
  }

  .session-delete:hover {
    color: #e55;
    background: rgba(238,85,85,0.08);
  }

  .session-delete svg {
    width: 14px;
    height: 14px;
    fill: currentColor;
  }

  .empty-state {
    padding: 2rem 0;
    text-align: center;
    color: var(--gray-400);
    font-size: 0.82rem;
    font-style: italic;
  }

  /* Easter egg: quote overlay */
  .quote-overlay {
    position: fixed;
    inset: 0;
    background: rgba(26,26,26,0.92);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
  }

  .quote-overlay.visible {
    opacity: 1;
    pointer-events: auto;
  }

  .quote-box {
    max-width: 520px;
    text-align: center;
    padding: 3rem;
  }

  .quote-box .quote-text {
    font-size: 1.5rem;
    font-weight: 300;
    color: var(--white);
    line-height: 1.6;
    margin-bottom: 1.25rem;
  }

  .quote-box .quote-attr {
    font-size: 0.78rem;
    color: var(--orange);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-weight: 500;
  }

  .quote-box .quote-dismiss {
    margin-top: 2rem;
    font-size: 0.7rem;
    color: var(--gray-500);
    letter-spacing: 0.05em;
  }

  /* Easter egg: 221B mode */
  .baker-street-mode nav {
    border-bottom-color: var(--orange);
  }

  .baker-street-mode .timer-body {
    background: #2d2d2d;
  }

  .baker-street-mode body,
  .baker-street-mode {
    background: #faf8f5;
  }

  /* Daily total */
  .daily-total {
    margin-top: 1.25rem;
    padding-top: 1rem;
    border-top: 2px solid var(--black);
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }

  .total-label {
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--gray-500);
  }

  .total-value {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--black);
    font-variant-numeric: tabular-nums;
  }

  /* Session name input */
  .session-input {
    width: 100%;
    max-width: 280px;
    height: 40px;
    padding: 0 0.85rem;
    border: 1.5px solid var(--gray-200);
    border-radius: var(--radius);
    font-family: inherit;
    font-size: 0.82rem;
    color: var(--black);
    background: var(--white);
    outline: none;
    transition: border-color 0.15s;
  }

  .session-input:focus {
    border-color: var(--orange);
  }

  .session-input::placeholder {
    color: var(--gray-400);
    font-style: italic;
  }

  /* Session name in today's list */
  .session-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--black);
  }

  /* Session name totals breakdown */
  .name-totals {
    margin-top: 0.75rem;
    padding: 0.6rem 0;
    border-top: 1px solid var(--gray-200);
  }

  .name-totals-label {
    font-size: 0.68rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--gray-400);
    margin-bottom: 0.4rem;
  }

  .name-total-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.3rem 0;
  }

  .name-total-name {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--black);
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .name-total-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--orange);
    flex-shrink: 0;
  }

  .name-total-count {
    font-size: 0.68rem;
    color: var(--gray-400);
    margin-left: 0.25rem;
    font-weight: 400;
  }

  .name-total-time {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--black);
    font-variant-numeric: tabular-nums;
  }

  /* Daily + Weekly totals */
  .totals-row {
    display: flex;
    gap: 1.5rem;
  }

  .total-block {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  /* History section */
  .history-section {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--gray-200);
  }

  .history-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .history-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--black);
  }

  /* Week navigation */
  .week-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .week-nav-btn {
    background: none;
    border: 1px solid var(--gray-200);
    border-radius: 4px;
    width: 28px;
    height: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-700);
    transition: all 0.15s;
  }

  .week-nav-btn:hover {
    background: var(--gray-100);
    border-color: var(--gray-300);
  }

  .week-nav-btn svg {
    width: 14px;
    height: 14px;
    fill: currentColor;
  }

  .week-label {
    font-size: 0.75rem;
    color: var(--gray-500);
    font-weight: 500;
    min-width: 100px;
    text-align: center;
  }

  /* Weekly bar chart */
  .week-chart {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    margin-bottom: 1.25rem;
  }

  .chart-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    height: 22px;
  }

  .chart-day {
    font-size: 0.68rem;
    font-weight: 500;
    color: var(--gray-500);
    width: 28px;
    text-align: right;
    flex-shrink: 0;
  }

  .chart-bar-wrap {
    flex: 1;
    height: 14px;
    background: var(--gray-100);
    border-radius: 3px;
    overflow: hidden;
  }

  .chart-bar {
    height: 100%;
    background: var(--orange);
    border-radius: 3px;
    min-width: 0;
    transition: width 0.3s ease;
  }

  .chart-bar.today-bar {
    background: var(--orange-light);
  }

  .chart-value {
    font-size: 0.68rem;
    color: var(--gray-500);
    font-variant-numeric: tabular-nums;
    width: 32px;
    flex-shrink: 0;
  }

  /* History date groups */
  .history-group {
    border-bottom: 1px solid var(--gray-100);
  }

  .history-group:last-child {
    border-bottom: none;
  }

  .history-group-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 0;
    cursor: pointer;
    user-select: none;
  }

  .history-group-header:hover {
    color: var(--orange);
  }

  .history-group-date {
    font-size: 0.8rem;
    font-weight: 600;
    color: inherit;
  }

  .history-group-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .history-group-total {
    font-size: 0.75rem;
    color: var(--gray-500);
    font-variant-numeric: tabular-nums;
  }

  .history-group-arrow {
    font-size: 0.65rem;
    color: var(--gray-400);
    transition: transform 0.2s;
  }

  .history-group.expanded .history-group-arrow {
    transform: rotate(90deg);
  }

  .history-group-sessions {
    display: none;
    padding-bottom: 0.5rem;
  }

  .history-group.expanded .history-group-sessions {
    display: block;
  }

  .history-session {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.35rem 0 0.35rem 1rem;
  }

  .history-session-name {
    font-size: 0.78rem;
    color: var(--gray-700);
  }

  .history-session-detail {
    font-size: 0.72rem;
    color: var(--gray-500);
    font-variant-numeric: tabular-nums;
  }

  .history-empty {
    padding: 1rem 0;
    text-align: center;
    color: var(--gray-400);
    font-size: 0.78rem;
    font-style: italic;
  }

  /* Responsive */
  @media (max-width: 768px) {
    nav { padding: 0.75rem 0.75rem; justify-content: space-between; }
    .nav-auth { position: static; transform: none; gap: 0.3rem; }
    .nav-date { position: static; transform: none; }
    .nav-logo-btn { position: static; transform: none; font-size: 0.6rem; padding: 0.2rem 0.5rem; }

    .main {
      flex-direction: column;
      align-items: center;
      gap: 3rem;
      padding: 2.5rem 1.25rem 3rem;
    }

    .session-section {
      width: 100%;
      max-width: 360px;
    }

    .timer-wrap { width: 280px; height: 280px; }
    .time-digits { font-size: 2.8rem; }
  }
</style>
</head>
<body>

<nav>
  <div class="nav-auth" id="authArea"></div>
  <span class="nav-date" id="navDate"></span>
  <a class="nav-logo-btn logo" href="/">Elementary Timer</a>
</nav>

<div class="main">
  <div class="timer-section">
    <input type="text" class="timer-heading-input" id="sessionInput" placeholder="What are you working on?" maxlength="60">

    <div class="timer-wrap" id="timerWrap">
      <div class="stopwatch-btn"></div>
      <div class="timer-body" id="timerBody">
        <div class="timer-fill" id="timerFill">
          <div class="timer-fill-inner"></div>
        </div>
        <div class="time-display">
          <div class="time-digits idle" id="display">00:00</div>
          <div class="time-label idle-label" id="statusLabel"></div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="startPauseBtn">
        <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        <span id="btnText">Start</span>
      </button>
      <button class="btn btn-secondary" id="resetBtn">
        <svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
        <span>Finish Session</span>
      </button>
    </div>
  </div>

  <div class="session-section">
    <div class="section-header">
      <span class="section-title">Today's Sessions</span>
      <span class="section-meta" id="sessionCount"></span>
    </div>
    <ul class="session-list" id="sessionList"></ul>
    <div class="name-totals" id="nameTotals"></div>
    <div class="daily-total">
      <div class="totals-row">
        <div class="total-block">
          <span class="total-label">Today</span>
          <span class="total-value" id="totalTime">0m</span>
        </div>
        <div class="total-block">
          <span class="total-label">This week</span>
          <span class="total-value" id="weeklyTotal">0m</span>
        </div>
      </div>
    </div>

    <div class="history-section" id="historySection">
      <div class="history-header">
        <span class="history-title">History</span>
        <div class="week-nav">
          <button class="week-nav-btn" id="weekPrev" title="Previous week">
            <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
          </button>
          <span class="week-label" id="weekLabel"></span>
          <button class="week-nav-btn" id="weekNext" title="Next week">
            <svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
          </button>
        </div>
      </div>
      <div class="week-chart" id="weekChart"></div>
      <div id="historyGroups"></div>
    </div>
  </div>
</div>

<!-- Clerk sign-in overlay -->
<div id="clerkOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;align-items:center;justify-content:center;">
  <div style="position:relative;">
    <button id="clerkClose" style="position:absolute;top:-12px;right:-12px;width:28px;height:28px;border-radius:50%;border:none;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.15);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;z-index:1;color:#555;">&times;</button>
    <div id="clerkMount"></div>
  </div>
</div>

<!-- Easter egg: quote overlay -->
<div class="quote-overlay" id="quoteOverlay">
  <div class="quote-box">
    <div class="quote-text" id="quoteText"></div>
    <div class="quote-attr" id="quoteAttr"></div>
    <div class="quote-dismiss">click anywhere to dismiss</div>
  </div>
</div>

<script>
  // Elements
  const display = document.getElementById('display');
  const timerWrap = document.getElementById('timerWrap');
  const timerBody = document.getElementById('timerBody');
  const timerFill = document.getElementById('timerFill');
  const startPauseBtn = document.getElementById('startPauseBtn');
  const resetBtn = document.getElementById('resetBtn');
  const playIcon = document.getElementById('playIcon');
  const btnText = document.getElementById('btnText');
  const statusLabel = document.getElementById('statusLabel');
  const sessionList = document.getElementById('sessionList');
  const totalTimeEl = document.getElementById('totalTime');
  const weeklyTotalEl = document.getElementById('weeklyTotal');
  const sessionCount = document.getElementById('sessionCount');
  const navDate = document.getElementById('navDate');
  const sessionInput = document.getElementById('sessionInput');
  const weekChart = document.getElementById('weekChart');
  const historyGroups = document.getElementById('historyGroups');
  const weekLabel = document.getElementById('weekLabel');
  const weekPrev = document.getElementById('weekPrev');
  const weekNext = document.getElementById('weekNext');
  const nameTotalsEl = document.getElementById('nameTotals');

  // Constants
  const ONE_HOUR = 3600; // seconds
  const SUPABASE_URL = 'https://mrphkxragldfngrkkuqs.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_C9Xjj5FztinEUw_ZVmFSnQ_qg09jxeE';

  // State
  let elapsed = 0;
  let interval = null;
  let running = false;
  let startTime = null;        // Date.now() when timer started/resumed
  let elapsedBeforePause = 0;  // seconds accumulated before last pause
  let sessions = JSON.parse(localStorage.getItem('et_sessions') || '[]');
  let weekOffset = 0; // 0 = current week, -1 = last week, etc.
  let currentUser = null;
  let supabaseClient = null;

  // ── Auth & Supabase ──────────────────────────────────
  function initSupabase() {
    if (window.supabase) {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  }

  async function initAuth() {
    try {
      await window.Clerk.load();
      window.Clerk.addListener(async ({ user }) => {
        currentUser = user;
        updateAuthUI();
        // Auto-close sign-in overlay on successful auth
        if (user) {
          const overlay = document.getElementById('clerkOverlay');
          if (overlay.style.display !== 'none') {
            overlay.style.display = 'none';
            window.Clerk.unmountSignIn(document.getElementById('clerkMount'));
          }
          initSupabase();
          await loadAndMergeFromSupabase();
        } else {
          sessions = JSON.parse(localStorage.getItem('et_sessions') || '[]');
          renderSessions();
          renderHistory();
        }
      });
      updateAuthUI();
    } catch (e) {
      console.error('Auth init failed:', e);
      updateAuthUI();
    }
  }

  function updateAuthUI() {
    const authArea = document.getElementById('authArea');
    if (!authArea) return;
    if (currentUser) {
      const fullName = currentUser.firstName || (currentUser.emailAddresses && currentUser.emailAddresses[0] ? currentUser.emailAddresses[0].emailAddress : 'User');
      const initial = fullName.charAt(0).toUpperCase();
      authArea.innerHTML = '<div class="auth-avatar" id="authAvatar">' + initial + '<div class="auth-dropdown" id="authDropdown"><button id="signOutBtn">Sign out</button></div></div>';
      document.getElementById('authAvatar').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('authDropdown').classList.toggle('open');
      });
      document.addEventListener('click', () => {
        const dd = document.getElementById('authDropdown');
        if (dd) dd.classList.remove('open');
      });
      document.getElementById('signOutBtn').addEventListener('click', () => window.Clerk.signOut());
    } else {
      authArea.innerHTML = '<button class="auth-btn" id="signInBtn">Sign in</button>';
      document.getElementById('signInBtn').addEventListener('click', () => {
        if (window.Clerk) {
          document.getElementById('clerkOverlay').style.display = 'flex';
          window.Clerk.mountSignIn(document.getElementById('clerkMount'), {
            appearance: { variables: { colorPrimary: '#FF6600' } }
          });
        }
      });
    }
  }

  async function loadAndMergeFromSupabase() {
    if (!currentUser || !supabaseClient) return;
    try {
      const { data, error } = await supabaseClient
        .from('timer_history')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('date', { ascending: true });
      if (error) throw error;

      const localSessions = JSON.parse(localStorage.getItem('et_sessions') || '[]');
      if (localSessions.length > 0 && data.length === 0) {
        await migrateLocalToSupabase(localSessions);
        return; // migrateLocalToSupabase will re-call this
      }

      // Merge cloud and local sessions (don't lose local-only sessions)
      const cloudSessions = (data || []).map(row => ({
        _sb_id: row.id,
        duration: row.duration,
        date: row.date,
        name: row.name || 'Deep Work'
      }));

      const localSessions2 = JSON.parse(localStorage.getItem('et_sessions') || '[]');
      const cloudDates = new Set(cloudSessions.map(s => s.date));

      // Find local sessions not in cloud (failed syncs)
      const localOnly = localSessions2.filter(s => !s._sb_id && !cloudDates.has(s.date));

      // Re-sync local-only sessions to cloud
      for (const s of localOnly) {
        const saved = await saveSessionToSupabase(s);
        if (saved) {
          s._sb_id = saved.id;
        }
      }

      sessions = [...cloudSessions, ...localOnly];
      // Sort by date so history renders correctly
      sessions.sort((a, b) => new Date(a.date) - new Date(b.date));
      localStorage.setItem('et_sessions', JSON.stringify(sessions));

      renderSessions();
      renderHistory();
    } catch (e) {
      console.error('Failed to load from Supabase:', e);
      // Fallback: render local sessions so history isn't blank
      sessions = JSON.parse(localStorage.getItem('et_sessions') || '[]');
      renderSessions();
      renderHistory();
    }
  }

  async function migrateLocalToSupabase(localSessions) {
    if (!currentUser || !supabaseClient) return;
    try {
      const rows = localSessions.map(s => ({
        user_id: currentUser.id,
        duration: s.duration,
        name: s.name || 'Deep Work',
        date: s.date
      }));
      const { error } = await supabaseClient
        .from('timer_history')
        .insert(rows);
      if (!error) {
        localStorage.removeItem('et_sessions');
        await loadAndMergeFromSupabase();
      }
    } catch (e) {
      console.error('Migration failed:', e);
    }
  }

  async function saveSessionToSupabase(session) {
    if (!currentUser || !supabaseClient) return null;
    try {
      const { data, error } = await supabaseClient
        .from('timer_history')
        .insert({
          user_id: currentUser.id,
          duration: session.duration,
          name: session.name,
          date: session.date
        })
        .select()
        .single();
      if (error) throw error;
      return data;
    } catch (e) {
      console.error('Failed to save to Supabase:', e);
      return null;
    }
  }

  async function deleteSessionFromSupabase(sbId) {
    if (!currentUser || !supabaseClient || !sbId) return;
    try {
      await supabaseClient
        .from('timer_history')
        .delete()
        .eq('id', sbId)
        .eq('user_id', currentUser.id);
    } catch (e) {
      console.error('Failed to delete from Supabase:', e);
    }
  }

  // Init auth when Clerk script loads
  if (document.querySelector('script[data-clerk-publishable-key]')) {
    const checkClerk = setInterval(() => {
      if (window.Clerk) {
        clearInterval(checkClerk);
        initAuth();
      }
    }, 100);
  }

  // Close Clerk overlay
  document.getElementById('clerkClose').addEventListener('click', () => {
    document.getElementById('clerkOverlay').style.display = 'none';
    if (window.Clerk) window.Clerk.unmountSignIn(document.getElementById('clerkMount'));
  });
  document.getElementById('clerkOverlay').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      document.getElementById('clerkOverlay').style.display = 'none';
      if (window.Clerk) window.Clerk.unmountSignIn(document.getElementById('clerkMount'));
    }
  });

  // Init disc fill
  function updateDiscFill(fraction) {
    const degrees = fraction * 360;
    timerFill.style.background = fraction === 0
      ? 'var(--gray-200)'
      : 'conic-gradient(var(--orange) ' + degrees + 'deg, var(--gray-200) ' + degrees + 'deg)';
  }
  updateDiscFill(0);

  // Set live date + time in nav
  function tickNav(){
    var d=new Date();
    var date=d.toLocaleDateString('en-US',{month:'numeric',day:'numeric',year:'numeric'});
    var time=d.toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'});
    navDate.innerHTML=date+'&emsp;&emsp;'+time;
  }
  tickNav();setInterval(tickNav,1000);

  // Format helpers
  function fmt(s) {
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const sec = s % 60;
    if (h > 0) return h + ':' + String(m).padStart(2, '0') + ':' + String(sec).padStart(2, '0');
    return String(m).padStart(2, '0') + ':' + String(sec).padStart(2, '0');
  }

  function fmtTotal(totalSec) {
    const h = Math.floor(totalSec / 3600);
    const m = Math.floor((totalSec % 3600) / 60);
    if (h > 0) return h + 'h ' + m + 'm';
    return m + 'm';
  }

  function fmtDuration(sec) {
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    if (h > 0) return s === 0 ? h + 'h ' + m + 'm' : h + 'h ' + m + 'm ' + s + 's';
    if (m === 0) return s + 's';
    if (s === 0) return m + 'm';
    return m + 'm ' + s + 's';
  }

  function fmtTime(dateStr) {
    return new Date(dateStr).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
  }

  function updateDisplay() {
    display.textContent = fmt(elapsed);

    const fraction = Math.min(elapsed / ONE_HOUR, 1);

    // Update disc fill
    updateDiscFill(fraction);

    // Toggle digit styling based on fill
    if (fraction > 0) {
      display.classList.remove('idle');
      display.classList.add('visible');
    } else {
      display.classList.add('idle');
      display.classList.remove('visible');
    }

    // Title
    document.title = running
      ? fmt(elapsed) + ' \u2014 Elementary Timer'
      : 'Elementary Timer';
  }

  // ── Easter Eggs ──────────────────────────────────────

  const quoteOverlay = document.getElementById('quoteOverlay');
  const quoteText = document.getElementById('quoteText');
  const quoteAttr = document.getElementById('quoteAttr');

  // Sherlock / Elementary quotes pool
  const quotes = [
    { text: '"The game is afoot."', attr: 'Sherlock Holmes' },
    { text: '"Elementary, my dear Watson."', attr: 'Sherlock Holmes' },
    { text: '"You see, but you do not observe. The distinction is clear."', attr: 'A Scandal in Bohemia' },
    { text: '"I am a brain, Watson. The rest of me is a mere appendix."', attr: 'The Adventure of the Mazarin Stone' },
    { text: '"The world is full of obvious things which nobody ever observes."', attr: 'The Hound of the Baskervilles' },
    { text: '"There is nothing more deceptive than an obvious fact."', attr: 'The Boscombe Valley Mystery' },
    { text: '"Every puzzle has an answer."', attr: 'Elementary, CBS' },
    { text: '"I\'m not a psychopath. I\'m a high-functioning sociopath. Do your research."', attr: 'Sherlock, BBC' },
    { text: '"My mind rebels at stagnation. Give me problems, give me work."', attr: 'The Sign of the Four' },
    { text: '"Data! Data! Data! I can\'t make bricks without clay."', attr: 'The Adventure of the Copper Beeches' },
    { text: '"When you have eliminated the impossible, whatever remains, however improbable, must be the truth."', attr: 'The Sign of the Four' },
    { text: '"The work is its own reward."', attr: 'Elementary, CBS' },
    { text: '"Is there any point to which you would wish to draw my attention?" "To the curious incident of the dog in the night-time." "The dog did nothing in the night-time." "That was the curious incident."', attr: 'Silver Blaze' },
    { text: '"I follow my own methods, and tell as much or as little as I choose. That is the advantage of being unofficial."', attr: 'Silver Blaze' },
    { text: '"See the value of imagination. We imagined what might have happened, acted upon the supposition, and find ourselves justified."', attr: 'Silver Blaze' },
  ];

  // Empty state quotes (rotate each load)
  const emptyQuotes = [
    'The game is afoot\u2026 start a session',
    'The needle awaits the haystack',
    'No data yet. Even Holmes needs evidence.',
    'Begin your deductions',
    '221B reasons to start focusing',
    'The dog did nothing\u2026 curious, isn\u2019t it?',
  ];

  // Short quotes for the status label
  const idleQuotes = [
    'The game is afoot',
    'Elementary, my dear Watson',
    'Give me problems, give me work',
    'The work is its own reward',
    'You see, but you do not observe',
    'Data! Data! Data!',
    'Every puzzle has an answer',
    'My mind rebels at stagnation',
  ];

  function getRandomIdleQuote() {
    return idleQuotes[Math.floor(Math.random() * idleQuotes.length)];
  }

  function getRandomQuote() {
    return quotes[Math.floor(Math.random() * quotes.length)];
  }

  function showQuoteOverlay(q) {
    if (!q) q = getRandomQuote();
    quoteText.textContent = q.text;
    quoteAttr.textContent = '\u2014 ' + q.attr;
    quoteOverlay.classList.add('visible');
  }

  quoteOverlay.addEventListener('click', () => {
    quoteOverlay.classList.remove('visible');
  });

  // Easter egg 1: Type "221b" anywhere to trigger quote
  let secretBuffer = '';
  document.addEventListener('keydown', (e) => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    secretBuffer += e.key.toLowerCase();
    if (secretBuffer.length > 20) secretBuffer = secretBuffer.slice(-20);

    if (secretBuffer.includes('221b')) {
      secretBuffer = '';
      document.documentElement.classList.toggle('baker-street-mode');
      showQuoteOverlay({
        text: '"You know my methods, Watson."',
        attr: '221B Baker Street'
      });
    }

    // Easter egg: Type "watson" for a quote
    if (secretBuffer.includes('watson')) {
      secretBuffer = '';
      showQuoteOverlay({
        text: '"I am lost without my Boswell."',
        attr: 'A Scandal in Bohemia'
      });
    }

    // Easter egg: Type "silver" (Silver Blaze)
    if (secretBuffer.includes('silver')) {
      secretBuffer = '';
      showQuoteOverlay({
        text: '"The dog did nothing in the night-time." "That was the curious incident."',
        attr: 'Silver Blaze'
      });
    }

    // Easter egg: Type "moriarty"
    if (secretBuffer.includes('moriarty')) {
      secretBuffer = '';
      showQuoteOverlay({
        text: '"The Napoleon of crime, Watson."',
        attr: 'The Final Problem'
      });
    }
  });

  // Easter egg 2: Click logo 7 times (The Seven Percent Solution)
  let logoClicks = 0;
  let logoClickTimer = null;
  document.querySelector('.logo').addEventListener('click', (e) => {
    e.preventDefault();
    logoClicks++;
    clearTimeout(logoClickTimer);
    logoClickTimer = setTimeout(() => { logoClicks = 0; }, 2000);

    if (logoClicks === 7) {
      logoClicks = 0;
      showQuoteOverlay({
        text: '"Which is it today? Morphine or cocaine?"',
        attr: 'The Seven Percent Solution'
      });
    }
  });

  // Easter egg 3: Special status text when running
  const runningLabels = [
    'The game is afoot',
    'Focusing',
    'Deducing',
    'Observing',
    'On the case',
    'The dog is silent',
  ];

  // (Easter eggs patched below via cloneNode)

  // Easter egg 4: Time-based title Easter eggs
  const timeTriggers = {
    420: 'The Seven Percent Solution',   // 7 minutes
    1021: 'A Study in Scarlet',          // ~17 min (1887 publication)
    1260: 'The Sign of the Four',        // 21 minutes
    1800: 'The Halfway Mark, Watson',    // 30 min
    2210: '221B Baker Street',           // 22:10 on the clock = 22m10s, close to 221
    2700: 'The dog did nothing',         // 45 min — Silver Blaze
    3600: 'The Final Problem',           // full hour
  };

  // Override tick to check for time triggers
  function tick() {
    const prev = elapsed;
    elapsed = elapsedBeforePause + Math.floor((Date.now() - startTime) / 1000);
    updateDisplay();

    // Check time-based Easter eggs (only trigger once per second crossed)
    for (let s = prev + 1; s <= elapsed; s++) {
      if (timeTriggers[s]) {
        statusLabel.textContent = timeTriggers[s];
        statusLabel.className = 'time-label running-label';
      }
      if (s === 141) {
        statusLabel.textContent = '2:21 \u2014 Baker St.';
        statusLabel.className = 'time-label running-label';
      }
    }
  }

  // Re-create start/pause button to inject themed labels
  // Remove old listener and re-add with Easter eggs
  const newStartPauseBtn = startPauseBtn.cloneNode(true);
  startPauseBtn.parentNode.replaceChild(newStartPauseBtn, startPauseBtn);

  // Re-grab references
  const startPauseBtnNew = newStartPauseBtn;
  const playIconNew = startPauseBtnNew.querySelector('svg');
  const btnTextNew = startPauseBtnNew.querySelector('span');

  startPauseBtnNew.addEventListener('click', () => {
    if (running) {
      clearInterval(interval);
      interval = null;
      running = false;
      elapsedBeforePause = elapsed;
      startTime = null;
      btnTextNew.textContent = 'Resume';
      playIconNew.innerHTML = '<path d="M8 5v14l11-7z"/>';
      startPauseBtnNew.className = 'btn btn-primary';
      statusLabel.textContent = getRandomIdleQuote();
      statusLabel.className = 'time-label paused-label';
      timerBody.classList.remove('running');
      timerWrap.classList.add('active');
    } else {
      running = true;
      startTime = Date.now();
      btnTextNew.textContent = 'Pause';
      playIconNew.innerHTML = '<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>';
      statusLabel.textContent = runningLabels[Math.floor(Math.random() * runningLabels.length)];
      statusLabel.className = 'time-label running-label';
      timerBody.classList.add('running');
      timerWrap.classList.add('active');
      interval = setInterval(tick, 1000);
    }
  });

  // Patch reset button too
  const newResetBtn = resetBtn.cloneNode(true);
  resetBtn.parentNode.replaceChild(newResetBtn, resetBtn);

  newResetBtn.addEventListener('click', async () => {
    if (elapsed >= 5) {
      const name = sessionInput.value.trim() || 'Deep Work';
      const session = { duration: elapsed, date: new Date().toISOString(), name: name };
      sessions.push(session);
      localStorage.setItem('et_sessions', JSON.stringify(sessions));
      if (currentUser && supabaseClient) {
        const saved = await saveSessionToSupabase(session);
        if (saved) {
          session._sb_id = saved.id;
          localStorage.setItem('et_sessions', JSON.stringify(sessions));
        }
      }
    }

    clearInterval(interval);
    interval = null;
    running = false;
    elapsed = 0;
    startTime = null;
    elapsedBeforePause = 0;
    sessionInput.value = '';

    btnTextNew.textContent = 'Start';
    playIconNew.innerHTML = '<path d="M8 5v14l11-7z"/>';
    startPauseBtnNew.className = 'btn btn-primary';
    statusLabel.textContent = getRandomIdleQuote();
    statusLabel.className = 'time-label idle-label';
    timerBody.classList.remove('running');
    timerWrap.classList.remove('active');
    display.classList.add('idle');
    display.classList.remove('visible');

    updateDisplay();
    renderSessions();
    renderHistory();
  });

  // Easter egg 5: Themed empty state messages
  function renderSessions() {
    const today = new Date().toDateString();
    const todaySessions = sessions.filter(s => new Date(s.date).toDateString() === today);

    sessionList.innerHTML = '';

    if (todaySessions.length === 0) {
      const randomEmpty = emptyQuotes[Math.floor(Math.random() * emptyQuotes.length)];
      sessionList.innerHTML = '<li class="empty-state">' + randomEmpty + '</li>';
      sessionCount.textContent = '';
    } else {
      sessionCount.textContent = todaySessions.length + ' session' + (todaySessions.length !== 1 ? 's' : '');
      todaySessions.forEach((s, i) => {
        const li = document.createElement('li');
        li.className = 'session-item';
        const globalIndex = sessions.indexOf(s);
        const sessionName = s.name || 'Deep Work';

        li.innerHTML =
          '<div class="session-left">' +
            '<div class="session-dot"></div>' +
            '<div class="session-info">' +
              '<span class="session-name">' + sessionName + '</span>' +
              '<span class="session-duration">' + fmtDuration(s.duration) + ' · ' + fmtTime(s.date) + '</span>' +
            '</div>' +
          '</div>' +
          '<button class="session-delete" data-idx="' + globalIndex + '" title="Delete session">' +
            '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>' +
          '</button>';

        sessionList.appendChild(li);
      });
    }

    const totalSec = todaySessions.reduce((sum, s) => sum + s.duration, 0);
    totalTimeEl.textContent = fmtTotal(totalSec);

    // Weekly total (current week Mon–Sun)
    const weekTotalSec = getWeekSessions(0).reduce((sum, s) => sum + s.duration, 0);
    weeklyTotalEl.textContent = fmtTotal(weekTotalSec);

    // Name totals breakdown (case-insensitive grouping)
    const nameMap = {};
    const nameDisplay = {}; // preserve first-seen casing for display
    todaySessions.forEach(s => {
      const n = s.name || 'Deep Work';
      const key = n.toLowerCase();
      if (!nameMap[key]) { nameMap[key] = { total: 0, count: 0 }; nameDisplay[key] = n; }
      nameMap[key].total += s.duration;
      nameMap[key].count++;
    });
    const uniqueKeys = Object.keys(nameMap);
    if (uniqueKeys.length > 1 || (uniqueKeys.length === 1 && nameMap[uniqueKeys[0]].count > 1)) {
      const sorted = uniqueKeys.sort((a, b) => nameMap[b].total - nameMap[a].total);
      nameTotalsEl.style.display = '';
      nameTotalsEl.innerHTML = '<div class="name-totals-label">By activity</div>' +
        sorted.map(key =>
          '<div class="name-total-row">' +
            '<span class="name-total-name"><span class="name-total-dot"></span>' + nameDisplay[key] +
              '<span class="name-total-count">&times;' + nameMap[key].count + '</span></span>' +
            '<span class="name-total-time">' + fmtTotal(nameMap[key].total) + '</span>' +
          '</div>'
        ).join('');
    } else {
      nameTotalsEl.style.display = 'none';
      nameTotalsEl.innerHTML = '';
    }

    // Wire delete buttons
    sessionList.querySelectorAll('.session-delete').forEach(btn => {
      btn.addEventListener('click', async () => {
        const idx = parseInt(btn.dataset.idx);
        const removed = sessions[idx];
        sessions.splice(idx, 1);
        localStorage.setItem('et_sessions', JSON.stringify(sessions));
        if (removed && removed._sb_id && currentUser && supabaseClient) {
          await deleteSessionFromSupabase(removed._sb_id);
        }
        renderSessions();
        renderHistory();
      });
    });

    // Easter egg: Show a quote when reaching certain session counts
    if (todaySessions.length === 3) {
      statusLabel.textContent = 'Three-pipe problem';
      statusLabel.className = 'time-label';
    }
    if (todaySessions.length === 5) {
      statusLabel.textContent = 'Most formidable';
      statusLabel.className = 'time-label';
    }
  }

  // ── History helpers ──────────────────────────────────
  function getMonday(d) {
    const date = new Date(d);
    const day = date.getDay();
    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
    date.setHours(0, 0, 0, 0);
    date.setDate(diff);
    return date;
  }

  function getWeekSessions(offset) {
    const monday = getMonday(new Date());
    monday.setDate(monday.getDate() + offset * 7);
    const sunday = new Date(monday);
    sunday.setDate(sunday.getDate() + 7);
    return sessions.filter(s => {
      const d = new Date(s.date);
      return d >= monday && d < sunday;
    });
  }

  function getWeekDays(offset) {
    const monday = getMonday(new Date());
    monday.setDate(monday.getDate() + offset * 7);
    const days = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(monday);
      d.setDate(d.getDate() + i);
      days.push(d);
    }
    return days;
  }

  function fmtShortDate(d) {
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function fmtWeekLabel(offset) {
    const days = getWeekDays(offset);
    if (offset === 0) return 'This Week';
    if (offset === -1) return 'Last Week';
    return fmtShortDate(days[0]) + ' – ' + fmtShortDate(days[6]);
  }

  const DAY_NAMES = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

  function renderHistory() {
    const days = getWeekDays(weekOffset);
    const today = new Date().toDateString();

    // Week label
    weekLabel.textContent = fmtWeekLabel(weekOffset);

    // Disable next if on current week
    weekNext.disabled = weekOffset >= 0;
    weekNext.style.opacity = weekOffset >= 0 ? '0.3' : '1';

    // Build per-day totals
    const dayTotals = days.map(d => {
      const ds = d.toDateString();
      return sessions
        .filter(s => new Date(s.date).toDateString() === ds)
        .reduce((sum, s) => sum + s.duration, 0);
    });

    const maxTotal = Math.max(...dayTotals, 1);

    // Render bar chart
    weekChart.innerHTML = days.map((d, i) => {
      const pct = (dayTotals[i] / maxTotal) * 100;
      const isToday = d.toDateString() === today;
      const barClass = isToday ? 'chart-bar today-bar' : 'chart-bar';
      return '<div class="chart-row">' +
        '<span class="chart-day">' + DAY_NAMES[i] + '</span>' +
        '<div class="chart-bar-wrap"><div class="' + barClass + '" style="width:' + pct + '%"></div></div>' +
        '<span class="chart-value">' + (dayTotals[i] > 0 ? fmtTotal(dayTotals[i]) : '—') + '</span>' +
      '</div>';
    }).join('');

    // Render date groups (only days with sessions, excluding today)
    const groupDays = days
      .filter(d => d.toDateString() !== today)
      .reverse();

    let groupsHtml = '';
    let hasAny = false;

    groupDays.forEach(d => {
      const ds = d.toDateString();
      const daySessions = sessions.filter(s => new Date(s.date).toDateString() === ds);
      if (daySessions.length === 0) return;
      hasAny = true;

      const dayTotal = daySessions.reduce((sum, s) => sum + s.duration, 0);
      const dateLabel = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

      groupsHtml += '<div class="history-group">' +
        '<div class="history-group-header">' +
          '<span class="history-group-date">' + dateLabel + '</span>' +
          '<div class="history-group-meta">' +
            '<span class="history-group-total">' + fmtTotal(dayTotal) + ' · ' + daySessions.length + ' session' + (daySessions.length !== 1 ? 's' : '') + '</span>' +
            '<span class="history-group-arrow">▶</span>' +
          '</div>' +
        '</div>' +
        '<div class="history-group-sessions">' +
          daySessions.map(s =>
            '<div class="history-session">' +
              '<span class="history-session-name">' + (s.name || 'Deep Work') + '</span>' +
              '<span class="history-session-detail">' + fmtDuration(s.duration) + ' · ' + fmtTime(s.date) + '</span>' +
            '</div>'
          ).join('') +
        '</div>' +
      '</div>';
    });

    if (!hasAny && weekOffset !== 0) {
      groupsHtml = '<div class="history-empty">No sessions this week</div>';
    } else if (!hasAny) {
      groupsHtml = '<div class="history-empty">Past sessions will appear here</div>';
    }

    historyGroups.innerHTML = groupsHtml;

    // Wire collapsible groups
    historyGroups.querySelectorAll('.history-group-header').forEach(header => {
      header.addEventListener('click', () => {
        header.parentElement.classList.toggle('expanded');
      });
    });
  }

  // Week navigation
  weekPrev.addEventListener('click', () => {
    weekOffset--;
    renderHistory();
  });

  weekNext.addEventListener('click', () => {
    if (weekOffset < 0) {
      weekOffset++;
      renderHistory();
    }
  });

  // Catch up when tab/app regains focus
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden && running) {
      tick(); // immediately sync elapsed from wall clock
    }
  });

  // Init
  statusLabel.textContent = getRandomIdleQuote();
  updateDisplay();
  renderSessions();
  renderHistory();

  // Console Easter egg for curious devs
  console.log('%c 221B ', 'background: #FF6600; color: white; font-size: 14px; font-weight: bold; border-radius: 3px;',
    'You know my methods. Type "221b" for a surprise.');
</script>

</body>
</html>
